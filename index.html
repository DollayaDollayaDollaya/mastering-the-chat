// Handle video generation button
videoButton.addEventListener('click', async () => {
    try {
        const heygenKey = localStorage.getItem('heygen_api_key');
        const avatarId = localStorage.getItem('heygen_avatar_id');
        
        if (!heygenKey || !avatarId) {
            throw new Error('HeyGen credentials not found');
        }
        
        // Show loading state
        videoButton.innerHTML = '<span class="loading"></span>Generating video...';
        videoButton.disabled = true;
        
        // Call HeyGen API with the correct format
        const response = await fetch('https://api.heygen.com/v2/video/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Api-Key': heygenKey  // Changed from Authorization Bearer format
            },
            body: JSON.stringify({
                "video_inputs": [
                    {
                        "character": {
                            "type": "avatar",
                            "avatar_id": avatarId,
                            "avatar_style": "normal"
                        },
                        "voice": {
                            "type": "text",
                            "input_text": createVideoScript(lastAiResponse),
                            "voice_id": "2d5b0e6cf36f460aa7fc47e3eee4ba54"  // Default voice ID
                        },
                        "background": {
                            "type": "color",
                            "value": "#f5f5f5"  // Light gray background
                        }
                    }
                ],
                "dimension": {
                    "width": 1280,
                    "height": 720
                }
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('HeyGen API Error:', errorText);
            throw new Error(`Error ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        // Check video status and wait for completion
        if (data.data && data.data.video_id) {
            const videoId = data.data.video_id;
            const videoUrl = await checkVideoStatus(videoId, heygenKey);
            
            // Display video when ready
            videoContainer.innerHTML = `
                <video controls width="100%" style="max-width: 600px;">
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <button id="video-button" style="margin-top: 15px;">Generate New Video</button>
            `;
            
            // Re-attach event listener to the new button
            document.getElementById('video-button').addEventListener('click', () => {
                videoButton.click();
            });
        } else {
            throw new Error('Video ID not received from HeyGen');
        }
        
    } catch (error) {
        console.error('Error generating video:', error);
        videoButton.disabled = false;
        videoButton.textContent = 'Try Again';
        videoContainer.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
    }
});

// Check video generation status - updated to match HeyGen's v1 endpoint
async function checkVideoStatus(videoId, apiKey) {
    return new Promise((resolve, reject) => {
        const maxAttempts = 60; // 5 minutes total (checking every 5 seconds)
        let attempts = 0;
        
        const checkStatus = async () => {
            try {
                // Using the v1 endpoint from the documentation
                const response = await fetch(`https://api.heygen.com/v1/video_status.get?video_id=${videoId}`, {
                    headers: {
                        'X-Api-Key': apiKey  // Updated header format
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to check video status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Video status response:', data);  // Log the full response for debugging
                
                if (data.data.status === 'completed') {
                    resolve(data.data.video_url);
                } else if (data.data.status === 'failed') {
                    reject(new Error(`Video generation failed: ${data.data.error || 'Unknown error'}`));
                } else if (attempts < maxAttempts) {
                    attempts++;
                    // Update the button with progress
                    videoButton.innerHTML = `<span class="loading"></span>Processing video (${attempts}/${maxAttempts})`;
                    setTimeout(checkStatus, 5000); // Check again in 5 seconds
                } else {
                    reject(new Error('Video generation timed out'));
                }
            } catch (error) {
                console.error('Error checking video status:', error);
                reject(error);
            }
        };
        
        checkStatus();
    });
}